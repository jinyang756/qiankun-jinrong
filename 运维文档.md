# 运维文档

## 1. 系统架构概述

### 1.1 技术栈
- 前端: HTML5, CSS3, JavaScript (ES6+), qiankun微前端框架
- 后端: Node.js, Express.js
- 数据库: PostgreSQL
- 缓存: Redis
- 队列: BullMQ
- 构建工具: Webpack
- 包管理: npm

### 1.2 系统组件
1. App Shell (主应用): 路由编排和微前端容器
2. Member App (会员端): 移动端风格的会员交易界面
3. Agent App (代理人端): 代理人管理和审批界面
4. Admin Console (管理端): 系统配置和管理界面
5. API Gateway: RESTful API服务和业务逻辑处理
6. Engine Core: 核心交易引擎和风控模块

## 2. 部署和启动

### 2.1 环境准备
```bash
# 安装依赖
npm install

# 为每个应用安装依赖
cd packages/member-app && npm install
cd ../agent-app && npm install
cd ../admin-console && npm install
cd ../api-gateway && npm install
cd ../engine-core && npm install
```

### 2.2 启动开发服务器
```bash
# 启动API网关
cd packages/api-gateway
npm start

# 启动各前端应用
cd packages/member-app
npm start

cd packages/agent-app
npm start

cd packages/admin-console
npm start
```

### 2.3 构建生产版本
```bash
# 构建各前端应用
cd packages/member-app
npm run build

cd packages/agent-app
npm run build

cd packages/admin-console
npm run build
```

## 3. 配置管理

### 3.1 环境变量
在`packages/api-gateway/.env`文件中配置:

```
# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/trading_system

# Redis配置
REDIS_URL=redis://localhost:6379

# JWT密钥
JWT_SECRET=your_jwt_secret_key

# 服务端口
PORT=3000
```

### 3.2 微前端配置
在`packages/app-shell/src/main.js`中配置各子应用的入口:

```javascript
registerMicroApps([
  {
    name: 'member',
    entry: '//localhost:8081',
    container: '#app-member',
    activeRule: '/member',
    props: baseProps
  },
  // 其他应用配置...
]);
```

## 4. 监控和日志

### 4.1 日志查看
```bash
# 查看API网关日志
tail -f packages/api-gateway/logs/app.log

# 查看各应用构建日志
cd packages/member-app && npm run build --verbose
```

### 4.2 性能监控
- 使用浏览器开发者工具监控前端性能
- 使用APM工具(如New Relic, DataDog)监控后端性能
- 监控数据库查询性能和连接数
- 监控Redis内存使用和命中率

## 5. 故障排除

### 5.1 常见问题

#### 微前端加载失败
1. 检查各子应用是否正常启动
2. 检查网络连接和跨域配置
3. 检查qiankun配置是否正确

#### API调用失败
1. 检查API服务是否正常运行
2. 检查数据库连接
3. 检查请求参数和认证信息

#### 构建失败
1. 检查Node.js版本是否兼容
2. 清理node_modules并重新安装依赖
3. 检查Webpack配置是否正确

### 5.2 诊断命令
```bash
# 检查端口占用
netstat -tulpn | grep :3000

# 检查进程状态
ps aux | grep node

# 检查磁盘空间
df -h

# 检查内存使用
free -m
```

## 6. 备份和恢复

### 6.1 数据库备份
```bash
# 备份数据库
pg_dump -h localhost -U username trading_system > backup.sql

# 恢复数据库
psql -h localhost -U username trading_system < backup.sql
```

### 6.2 配置文件备份
```bash
# 备份重要配置文件
tar -czf config_backup.tar.gz packages/*/config packages/*/.env
```

## 7. 安全管理

### 7.1 安全更新
```bash
# 检查过时的依赖包
npm outdated

# 更新依赖包
npm update

# 安全审计
npm audit
npm audit fix
```

### 7.2 访问控制
- 定期检查和更新用户权限
- 监控异常登录和访问行为
- 实施IP白名单和2FA认证

## 8. 性能优化

### 8.1 数据库优化
- 定期分析和优化慢查询
- 添加适当的索引
- 清理过期数据

### 8.2 缓存优化
- 配置Redis内存策略
- 优化缓存键设计
- 监控缓存命中率

### 8.3 前端优化
- 启用Gzip压缩
- 使用CDN加速静态资源
- 实施懒加载和代码分割